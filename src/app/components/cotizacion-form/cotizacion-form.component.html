<h2>{{ cotizacion.id ? 'Editar Cotización' : 'Nueva Cotización' }}</h2>


<form (ngSubmit)="guardar()" #form="ngForm">
    <div>
        <label>Estado</label>
        <input type="text" name="estado" [(ngModel)]="cotizacion.estado" [readonly]="true" />

        <label>Fecha</label>
        <input type="text" name="fecha" [(ngModel)]="cotizacion.fecha" [readonly]="true" />
    </div>
    <!--<div>
        <label>Nro de Cotización:</label>
        <input type="text" name="cliente" [(ngModel)]="cotizacion.numeroCotizacion" required />
    </div> -->
    <input type="text" name="clienteId" [(ngModel)]="cotizacion.cliente!.id" hidden />
    <input type="text" name="vehiculoId" [(ngModel)]="cotizacion.vehiculo!.id" hidden />

    <!-- Cliente -->
    <!-- CHat, aquí tiene que incluirse un botón de busca del nro del documento, si lo encuentra
      llena los campos faltantes, si no lo encuentra, se activan para agregarlos y crear un nuevo cliente -->
    <!-- Tipo de documento -->
    <div>
        <label>Tipo de documento:</label>
        <select id="typeDocument" class="form-control" name="typeDocument"
            [(ngModel)]="cotizacion.cliente!.typeDocument" [ngModelOptions]="{standalone: true}">
            <option value="">Seleccione un tipo de documento</option>
            <option *ngFor="let tipo of typeDocument" [value]="tipo">
                {{ tipo }}
            </option>
        </select>
    </div>

    <!-- Número de documento -->
    <div class="mt-2">
        <label>Nro de Documento:</label>
        <input type="text" name="documentNumber" [(ngModel)]="cotizacion.cliente!.documentNumber" required />
        <button type="button" class="btn btn-sm btn-secondary" (click)="buscarClientePorDocumento()">
            Buscar
        </button>
    </div>

    <!-- Si cliente fue encontrado -->
    <div *ngIf="clienteEncontrado === true && busquedaRealizada" class="mt-3">
        <div *ngIf="cotizacion.cliente?.typeDocument === 'DNI'">
            <label>Nombre:</label>
            <input type="text" name="firstName" [(ngModel)]="cotizacion.cliente!.firstName" [readonly]="true" />

            <label>Apellido:</label>
            <input type="text" name="lastName" [(ngModel)]="cotizacion.cliente!.lastName" [readonly]="true" />
        </div>
        <div *ngIf="cotizacion.cliente?.typeDocument === 'RUC'">
            <label>Razón Social:</label>
            <input type="text" name="businessName" [(ngModel)]="cotizacion.cliente!.businessName" [readonly]="true" />
        </div>
        <div>
            <label>Email:</label>
            <input type="text" name="email" [(ngModel)]="cotizacion.cliente!.email" [readonly]="true" />
        </div>
        <div>
            <label>Celular:</label>
            <input type="text" name="phoneNumber" [(ngModel)]="cotizacion.cliente!.phoneNumber" [readonly]="true" />
        </div>
    </div>

    <!-- Si cliente no fue encontrado -->
    <div *ngIf="clienteEncontrado === false && busquedaRealizada" class="mt-3">
        <p class="text-danger">Cliente no encontrado.</p>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalAgregarCliente">
            Agregar cliente
        </button>
    </div>


    <div>
        <label>Placa del vehículo:</label>
        <input type="text" name="placa" [(ngModel)]="cotizacion.vehiculo!.placa" required
             />
        <button type="button" (click)="buscarVehiculoPorPlaca()">Buscar</button>
    </div>
    <div *ngIf="vehiculoEncontrado === true && busquedaVehiculoRealizada" class="mt-3">
        <div>
            <label>Marca:</label>
            <input type="text" name="marca" [(ngModel)]="cotizacion.vehiculo!.marca" [readonly]="true" />
        </div>

        <div>
            <label>Modelo:</label>
            <input type="text" name="modelo" [(ngModel)]="cotizacion.vehiculo!.modelo" [readonly]="true" />
        </div>

        <div>
            <label>Año:</label>
            <input type="text" name="year" [(ngModel)]="cotizacion.vehiculo!.year" [readonly]="true" />
        </div>
    </div>
    <div *ngIf="vehiculoEncontrado === false && busquedaVehiculoRealizada" class="mt-3">
        <p class="text-danger">Vehículo no encontrado.</p>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalAgregarVehículo">
            Agregar Vehículo
        </button>
    </div>
    <hr />

    <!-- Input para buscar productos -->
    <div class="form-group">
        <label for="busquedaProducto">Buscar producto</label>
        <input type="text" class="form-control" id="busquedaProducto" [(ngModel)]="busquedaProducto"
            (ngModelChange)="buscarProducto()" name="busquedaProducto" placeholder="Escribe el nombre del producto" />

        <!-- Lista de sugerencias -->
        <ul *ngIf="productosFiltrados.length > 0" class="list-group mt-1">
            <li class="list-group-item list-group-item-action" *ngFor="let producto of productosFiltrados"
                (click)="agregarProducto(producto)" style="cursor: pointer;">
                {{ producto.name }} - S/. {{ producto.salePrice }}
            </li>
        </ul>
    </div>

    <hr />

    <!-- Lista de productos añadidos (detalles) -->
    <h5>Productos seleccionados</h5>
    <table class="table table-bordered" *ngIf="cotizacion.detalles.length > 0">
        <thead>
            <tr>
                <th>Nombre</th>
                <th>Cantidad</th>
                <th>Precio Unitario</th>
                <th>Subtotal</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            <tr *ngFor="let detalle of cotizacion.detalles">
                <td>{{ detalle.nombreProducto }}</td>
                <td>
                    <input type="number" [(ngModel)]="detalle.cantidad" (change)="actualizarTotales()"
                        class="form-control" min="1" name="cantidad-{{detalle.productoId}}" />
                </td>
                <td>{{ detalle.precioUnitario | currency:'PEN' }}</td>
                <td>{{ detalle.subtotal | currency:'PEN' }}</td>

                <td>
                    <button type="button" class="btn btn-danger btn-sm" (click)="eliminarProducto(detalle)">
                        Eliminar
                    </button>

                </td>
            </tr>
        </tbody>
    </table>

    <div class="mt-4">
        <p><strong>Subtotal:</strong> {{ cotizacion.subtotal | currency:'PEN' }}</p>
        <p><strong>IGV (18%):</strong> {{ cotizacion.igv | currency:'PEN' }}</p>
        <p><strong>Total:</strong> {{ cotizacion.total | currency:'PEN' }}</p>
    </div>


    <div>
        <label>Observaciones:</label>
        <textarea name="observaciones" [(ngModel)]="cotizacion.observaciones"></textarea>
    </div>

    <br />
    <button type="submit" class="btn btn-success">
        {{ cotizacion.id ? 'Actualizar Cotización' : 'Registrar Cotización' }}
    </button>
    <button type="button" class="btn btn-secondary" routerLink="/cotizaciones">Cancelar</button>

</form>


<!-- Modal para agregar cliente -->
<div class="modal fade" id="modalAgregarCliente" tabindex="-1" aria-labelledby="modalAgregarClienteLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title" id="modalAgregarClienteLabel">Agregar nuevo cliente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>

            <div class="modal-body">
                <!-- Aquí va tu formulario de cliente -->
                <form>

                    <div class="mb-3">
                        <label>Tipo de documento:</label>
                        <select class="form-control" [(ngModel)]="cotizacion.cliente!.typeDocument" name="typeDocument"
                            [ngModelOptions]="{standalone: true}">
                            <option value="">Seleccione un tipo</option>
                            <option *ngFor="let tipo of typeDocument" [value]="tipo">{{ tipo }}</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label>Nro de Documento:</label>
                        <input type="text" class="form-control" [(ngModel)]="cotizacion.cliente!.documentNumber"
                            name="documentNumber" [readonly]="true" [ngModelOptions]="{standalone: true}" />
                    </div>
                    <div *ngIf="cotizacion.cliente?.typeDocument === 'DNI'">
                        <div class="mb-3">
                            <label>Nombre:</label>
                            <input type="text" class="form-control" [(ngModel)]="cotizacion.cliente!.firstName"
                                name="firstName" [ngModelOptions]="{standalone: true}" />
                        </div>

                        <div class="mb-3">
                            <label>Apellido:</label>
                            <input type="text" class="form-control" [(ngModel)]="cotizacion.cliente!.lastName"
                                name="lastName" [ngModelOptions]="{standalone: true}" />
                        </div>
                    </div>
                    <div *ngIf="cotizacion.cliente?.typeDocument === 'RUC'">
                        <div class="mb-3">
                            <label>Razón Social:</label>
                            <input type="text" class="form-control" [(ngModel)]="cotizacion.cliente!.businessName"
                                name="businessName" [ngModelOptions]="{standalone: true}" />
                        </div>
                    </div>

                    <div class="mb-3">
                        <label>Email:</label>
                        <input type="email" class="form-control" [(ngModel)]="cotizacion.cliente!.email" name="email"
                            [ngModelOptions]="{standalone: true}" />
                    </div>

                    <div class="mb-3">
                        <label>Celular:</label>
                        <input type="text" class="form-control" [(ngModel)]="cotizacion.cliente!.phoneNumber"
                            name="phoneNumber" [ngModelOptions]="{standalone: true}" />
                    </div>

                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" (click)="guardarCliente()">Guardar cliente</button>
            </div>

        </div>
    </div>
</div>




<!-- Modal Agregar Vehículo -->
<div class="modal fade" id="modalAgregarVehículo" tabindex="-1" aria-labelledby="modalAgregarVehículoLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalAgregarVehículoLabel">Agregar Vehículo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label>Placa:</label>
                    <input type="text" class="form-control" [(ngModel)]="cotizacion.vehiculo!.placa" name="placa" />
                </div>
                <div class="mb-3">
                    <label>Marca:</label>
                    <input type="text" class="form-control" [(ngModel)]="cotizacion.vehiculo!.marca" name="marca" />
                </div>
                <div class="mb-3">
                    <label>Modelo:</label>
                    <input type="text" class="form-control" [(ngModel)]="cotizacion.vehiculo!.modelo" name="modelo" />
                </div>
                <div class="mb-3">
                    <label>Año:</label>
                    <input type="text" class="form-control" [(ngModel)]="cotizacion.vehiculo!.year" name="year" />
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" (click)="guardarVehiculo()">Guardar Vehículo</button>
            </div>
        </div>
    </div>
</div>